<?php

/**
 * 
 * Blanchy Polangcos
 * 
 * Upload malware with a name and signature to the database.
 * 
 */
    if(session_id() == '') {
        session_start();
    }

    if ($_SESSION['check'] != hash('ripemd128', $_SERVER['REMOTE_ADDR'] .
    $_SERVER['HTTP_USER_AGENT'])) {
        echo "Your current location does not match the one given for this session. Try logging in again.";
        require_once("logout.php");
        exit;
    }

//echo session_id();
if (isset($_SESSION['un'])) {
    echo 'Current user: '.$_SESSION['un'].'<br>';
   if (!($_SESSION['type'])==0) {
        if (($_SESSION['type'])==1) {
            require_once("welcomeuser.php");
            exit;
        }
        else {
            echo "You are not authorized to view this page. Please log in again.<br>";
            require_once("logout.php");
            exit;
        }
   }
}
else {
    echo 'No user set.<br>';
    echo "You are not authorized to view this page. Please log in again.<br>";
        require_once("logout.php");
        exit;
}
?>

<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>Registering Malware</title>
    </head>
    <script type="text/javascript" src="formvalidation1.js"></script>
<body>

<?php
require_once('dbproperties.php');
require_once('allmalwares.php');
$table = print_tables();

echo $table;

///CHECK FOR VALID TYPE

function check_string($s) {
    if (!preg_match('/[^A-Za-z0-9]/', $s) && strlen($s) > 0 && strlen($s) < 12) // '/[^a-z\d]/i' should also work.
    {
    //echo "string contains only english letters & digits<br>";
        return true;
    }
    else
    {
        //echo "string is invalid";
        return false;
    }
}

function get_twenty($f) {
    $data = NULL;
    $fh = fopen($f,'r') or die("Could not open file.");
    if (flock($fh, LOCK_EX)) {
        //echo "Opening file...<br>";
        // read first 20
        $data = fread($fh, 20);
        flock($fh,LOCK_UN);
    }
    else echo "Error opening file.<br>";
    fclose($fh);
    return $data;
}

function is_unique($conn, $name) {
    $query = "SELECT * FROM malwares WHERE mname = ?";
    $stmt = $conn->prepare($query);
    $stmt->bind_param("s", $name);
    $stmt->execute();
    $stmt->store_result();
    //echo $stmt->num_rows;
    if (!$stmt) {
        echo "Error reading from database. <br>";
        die($conn->error);
    }
    if ($stmt->num_rows > 0) {
        $stmt->close();
        return false;
    }
    else  {
        $stmt->close();
        return true;
    }
}

function sanitize($s) {
    if (get_magic_quotes_gpc()) $s = stripslashes($s);
    $s = strip_tags($s);
    return htmlentities($s);
}

function insert_mal($conn, $bytes, $mname) {
    $stmt = $conn->prepare('INSERT INTO malwares VALUES(NULL,?,?)'); // mID, name, bytes
    $stmt->bind_param('ss', $bytes, $mname);
    $stmt->execute();

    //echo "$mname has been added to the database.\n";
    //printf("%d Row inserted. <br>", $stmt->affected_rows);

    $stmt->close();
}

if ($_FILES && $_FILES['infile']['type']) {
    //echo "Recieved file.  <br>  ";

    //// INVALID FILE
    if ($_FILES['infile']['type'] != 'text/plain') {
        echo 'Invalid file. Txt accepted only.<br>';
    }

    //// VALID FILE
    else {
        //echo 'Valid file. <br>';
        $mname = $_POST['mname'];
        $conn = new mysqli($host, $un, $pw, $db);
        if (check_string($mname))
        {
            $mname = sanitize($mname);
            if ($conn->connect_error) die($conn->connect_error);
            if (is_unique($conn, $mname)) {
                $sig = sanitize(get_twenty($_FILES['infile']['tmp_name']));
                if ($sig) {
                    insert_mal($conn, $mname, $sig);
                    echo "Added signature of $mname to database: $sig<br>";
                }
                else echo "Could not read malware signature to database.<br>";
            }
            else {
                echo "Please enter a different name.<br>";
            }
        }
        else {
            echo "Name must be alphanumeric and less than 12 characters.<br>";
        }
        $conn->close();
    }
}
//// NO FILE RECIEVED
else {
    echo "Upload a file.<br>";
}
?>

<div>
    <form action="uploadmalware.php"
        method="post"
        enctype="multipart/form-data"
        onsubmit="return valAlphanumeric(this)">
        <fieldset>
            <legend>Upload malware</legend>
            <p>
                <label>Malware name: </label>
                <input name="mname" type="text"/>
            </p>
            <p>
                <label>Upload file: </label><br>
                <input type="file" name="infile" id="infile">
            </p>
            <p>
                <input type="submit">
            </p>
        </fieldset>
    </form>
</div>
<div>
    <form method="post" action="welcomeadmin.php">
        <button type="submit">Go to Admin Home</button>
</div>
</body>
</html>