<?php
if(session_id() == '') {
    session_start();
}
//echo session_id();
if (isset($_SESSION['un'])) {
    echo 'Current user: '.$_SESSION['un'].'<br>';
}
else {
    echo 'No user set.<br>';
}

?>

<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>Registering Malware</title>
    </head>
<body>

<?php
require_once('dbproperties.php');
require_once('allmalwares.php');

///CHECK FOR VALID TYPE

function check_string($s) {
    if (!preg_match('/[^A-Za-z0-9]/', $s) && strlen($s) > 0) // '/[^a-z\d]/i' should also work.
    {
    echo "string contains only english letters & digits<br>";
    return true;
    }
    else
    {
        echo "string is invalid";
        return false;
    }
}

function get_twenty($f) {
    $fh = fopen($f,'r') or die("Could not open file.");
    echo "Opening file...<br>";
    // read first 20
    $data = fread($fh, 20);
    echo "Malware is: ".$data."<br>";
}

function is_unique($conn, $name) {
    $query = "SELECT * FROM $maltb where malname = '$name'";
    $result = $conn->query($query);
    if (!$result) {
        echo "error executing query";
        die($conn->error);
    }
    if ($result->num_rows > 0) {
        $result->close();
        return false;
    }
    else  {
        $result->close();
        return true;
    }
}

function insert_mal($conn, $bytes, $mname) {
    $stmt = $conn->prepare('INSERT INTO '.$maltb.' VALUES(NULL,?,?)'); // mID, name, bytes
    $stmt->bind_param('sss', $mname, $bytes);
    $stmt->execute();

    printf("%d Row inserted.\n", $stmt->affected_rows);

    $stmt->close();
}

if ($_FILES && $_FILES['infile']['type']) {
    echo "Recieved file.  <br>  ";

    //// INVALID FILE
    if ($_FILES['infile']['type'] != 'text/plain') {
        echo 'Invalid file. Txt accepted only.<br>';
    }

    //// VALID FILE
    else {
        echo 'Valid file. <br>';
        $mname = $_POST['mname'];
        if (check_string($mname))
        {
            $conn = new mysqli($host, $un, $pw, $db);
            if ($conn->connect_error) die($conn->connect_error);
            if (is_unique($conn, $mname)) {
                insert_mal($conn, $mname, get_twenty($_FILES['infile']['tmp_name']));
            }
            $conn->close();
            //echo $_FILES['infile']['name'];
            
        };
    }
}
//// NO FILE RECIEVED
else {
    echo "Currently holds no files.<br>";
}
?>

<div>
    <form action="uploadmalware.php"
        method="post"
        enctype="multipart/form-data">
        <fieldset>
            <legend>Upload malware</legend>
            <p>
                <label>Malware name: </label>
                <input name="mname" type="text"/>
            </p>
            <p>
                <label>Upload file: </label><br>
                <input type="file" name="infile" id="infile">
            </p>
            <p>
                <input type="submit">
            </p>
        </fieldset>
    </form>
</div>
<div>
    <form method="post" action="welcomeadmin.html">
        <button type="submit">Go to Admin Home</button>
</div>
</body>
</html>